/*The Code Project Open License (CPOL) 1.02

Preamble

This License governs Your use of the Work. This License is intended to allow developers to use the Source Code and Executable Files provided as part of the Work in any application in any form.
The main points subject to the terms of the License are:

- Source Code and Executable Files can be used in commercial applications;
- Source Code and Executable Files can be redistributed; and
- Source Code can be modified to create derivative works.
- No claim of suitability, guarantee, or any warranty whatsoever is provided. The software is provided "as-is".
- The Article accompanying the Work may not be distributed or republished without the Author's consent
This License is entered between You, the individual or other entity reading or otherwise making use of the Work licensed pursuant to this License and the individual or other entity which offers the Work under the terms of this License ("Author").

License

THE WORK (AS DEFINED BELOW) IS PROVIDED UNDER THE TERMS OF THIS CODE PROJECT OPEN LICENSE ("LICENSE"). THE WORK IS PROTECTED BY COPYRIGHT AND/OR OTHER APPLICABLE LAW. ANY USE OF THE WORK OTHER THAN AS AUTHORIZED UNDER THIS LICENSE OR COPYRIGHT LAW IS PROHIBITED.

BY EXERCISING ANY RIGHTS TO THE WORK PROVIDED HEREIN, YOU ACCEPT AND AGREE TO BE BOUND BY THE TERMS OF THIS LICENSE. THE AUTHOR GRANTS YOU THE RIGHTS CONTAINED HEREIN IN CONSIDERATION OF YOUR ACCEPTANCE OF SUCH TERMS AND CONDITIONS. IF YOU DO NOT AGREE TO ACCEPT AND BE BOUND BY THE TERMS OF THIS LICENSE, YOU CANNOT MAKE ANY USE OF THE WORK.

1. Definitions.
a. "Articles" means, collectively, all articles written by Author which describes how the Source Code and Executable Files for the Work may be used by a user.
b. "Author" means the individual or entity that offers the Work under the terms of this License.
c. "Derivative Work" means a work based upon the Work or upon the Work and other pre-existing works.
d. "Executable Files" refer to the executables, binary files, configuration and any required data files included in the Work.
e. "Publisher" means the provider of the website, magazine, CD-ROM, DVD or other medium from or by which the Work is obtained by You.
f. "Source Code" refers to the collection of source code and configuration files used to create the Executable Files.
g. "Standard Version" refers to such a Work if it has not been modified, or has been modified in accordance with the consent of the Author, such consent being in the full discretion of the Author.
h. "Work" refers to the collection of files distributed by the Publisher, including the Source Code, Executable Files, binaries, data files, documentation, whitepapers and the Articles.
i. "You" is you, an individual or entity wishing to use the Work and exercise your rights under this License.
2. Fair Use/Fair Use Rights. Nothing in this License is intended to reduce, limit, or restrict any rights arising from fair use, fair dealing, first sale or other limitations on the exclusive rights of the copyright owner under copyright law or other applicable laws.
3. License Grant. Subject to the terms and conditions of this License, the Author hereby grants You a worldwide, royalty-free, non-exclusive, perpetual (for the duration of the applicable copyright) license to exercise the rights in the Work as stated below:
a. You may use the standard version of the Source Code or Executable Files in Your own applications.
b. You may apply bug fixes, portability fixes and other modifications obtained from the Public Domain or from the Author. A Work modified in such a way shall still be considered the standard version and will be subject to this License.
c. You may otherwise modify Your copy of this Work (excluding the Articles) in any way to create a Derivative Work, provided that You insert a prominent notice in each changed file stating how, when and where You changed that file.
d. You may distribute the standard version of the Executable Files and Source Code or Derivative Work in aggregate with other (possibly commercial) programs as part of a larger (possibly commercial) software distribution.
e. The Articles discussing the Work published in any form by the author may not be distributed or republished without the Author's consent. The author retains copyright to any such Articles. You may use the Executable Files and Source Code pursuant to this License but you may not repost or republish or otherwise distribute or make available the Articles, without the prior written consent of the Author.
Any subroutines or modules supplied by You and linked into the Source Code or Executable Files of this Work shall not be considered part of this Work and will not be subject to the terms of this License.

4. Patent License. Subject to the terms and conditions of this License, each Author hereby grants to You a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable (except as stated in this section) patent license to make, have made, use, import, and otherwise transfer the Work.
5. Restrictions. The license granted in Section 3 above is expressly made subject to and limited by the following restrictions:
a. You agree not to remove any of the original copyright, patent, trademark, and attribution notices and associated disclaimers that may appear in the Source Code or Executable Files.
b. You agree not to advertise or in any way imply that this Work is a product of Your own.
c. The name of the Author may not be used to endorse or promote products derived from the Work without the prior written consent of the Author.
d. You agree not to sell, lease, or rent any part of the Work. This does not restrict you from including the Work or any part of the Work inside a larger software distribution that itself is being sold. The Work by itself, though, cannot be sold, leased or rented.
e. You may distribute the Executable Files and Source Code only under the terms of this License, and You must include a copy of, or the Uniform Resource Identifier for, this License with every copy of the Executable Files or Source Code You distribute and ensure that anyone receiving such Executable Files and Source Code agrees that the terms of this License apply to such Executable Files and/or Source Code. You may not offer or impose any terms on the Work that alter or restrict the terms of this License or the recipients' exercise of the rights granted hereunder. You may not sublicense the Work. You must keep intact all notices that refer to this License and to the disclaimer of warranties. You may not distribute the Executable Files or Source Code with any technological measures that control access or use of the Work in a manner inconsistent with the terms of this License.
f. You agree not to use the Work for illegal, immoral or improper purposes, or on pages containing illegal, immoral or improper material. The Work is subject to applicable export laws. You agree to comply with all such laws and regulations that may apply to the Work after Your receipt of the Work.
6. Representations, Warranties and Disclaimer. THIS WORK IS PROVIDED "AS IS", "WHERE IS" AND "AS AVAILABLE", WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES OR CONDITIONS OR GUARANTEES. YOU, THE USER, ASSUME ALL RISK IN ITS USE, INCLUDING COPYRIGHT INFRINGEMENT, PATENT INFRINGEMENT, SUITABILITY, ETC. AUTHOR EXPRESSLY DISCLAIMS ALL EXPRESS, IMPLIED OR STATUTORY WARRANTIES OR CONDITIONS, INCLUDING WITHOUT LIMITATION, WARRANTIES OR CONDITIONS OF MERCHANTABILITY, MERCHANTABLE QUALITY OR FITNESS FOR A PARTICULAR PURPOSE, OR ANY WARRANTY OF TITLE OR NON-INFRINGEMENT, OR THAT THE WORK (OR ANY PORTION THEREOF) IS CORRECT, USEFUL, BUG-FREE OR FREE OF VIRUSES. YOU MUST PASS THIS DISCLAIMER ON WHENEVER YOU DISTRIBUTE THE WORK OR DERIVATIVE WORKS.
7. Indemnity. You agree to defend, indemnify and hold harmless the Author and the Publisher from and against any claims, suits, losses, damages, liabilities, costs, and expenses (including reasonable legal or attorneys' fees) resulting from or relating to any use of the Work by You.
8. Limitation on Liability. EXCEPT TO THE EXTENT REQUIRED BY APPLICABLE LAW, IN NO EVENT WILL THE AUTHOR OR THE PUBLISHER BE LIABLE TO YOU ON ANY LEGAL THEORY FOR ANY SPECIAL, INCIDENTAL, CONSEQUENTIAL, PUNITIVE OR EXEMPLARY DAMAGES ARISING OUT OF THIS LICENSE OR THE USE OF THE WORK OR OTHERWISE, EVEN IF THE AUTHOR OR THE PUBLISHER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
9. Termination.
a. This License and the rights granted hereunder will terminate automatically upon any breach by You of any term of this License. Individuals or entities who have received Derivative Works from You under this License, however, will not have their licenses terminated provided such individuals or entities remain in full compliance with those licenses. Sections 1, 2, 6, 7, 8, 9, 10 and 11 will survive any termination of this License.
b. If You bring a copyright, trademark, patent or any other infringement claim against any contributor over infringements You claim are made by the Work, your License from such contributor to the Work ends automatically.
c. Subject to the above terms and conditions, this License is perpetual (for the duration of the applicable copyright in the Work). Notwithstanding the above, the Author reserves the right to release the Work under different license terms or to stop distributing the Work at any time; provided, however that any such election will not serve to withdraw this License (or any other license that has been, or is required to be, granted under the terms of this License), and this License will continue in full force and effect unless terminated as stated above.
10. Publisher. The parties hereby confirm that the Publisher shall not, under any circumstances, be responsible for and shall not have any liability in respect of the subject matter of this License. The Publisher makes no warranty whatsoever in connection with the Work and shall not be liable to You or any party on any legal theory for any damages whatsoever, including without limitation any general, special, incidental or consequential damages arising in connection to this license. The Publisher reserves the right to cease making the Work available to You at any time without notice
11. Miscellaneous
a. This License shall be governed by the laws of the location of the head office of the Author or if the Author is an individual, the laws of location of the principal place of residence of the Author.
b. If any provision of this License is invalid or unenforceable under applicable law, it shall not affect the validity or enforceability of the remainder of the terms of this License, and without further action by the parties to this License, such provision shall be reformed to the minimum extent necessary to make such provision valid and enforceable.
c. No term or provision of this License shall be deemed waived and no breach consented to unless such waiver or consent shall be in writing and signed by the party to be charged with such waiver or consent.
d. This License constitutes the entire agreement between the parties with respect to the Work licensed herein. There are no understandings, agreements or representations with respect to the Work not specified herein. The Author shall not be bound by any additional provisions that may appear in any communication from You. This License may not be modified without the mutual written agreement of the Author and You.*/

// ************************************************************************
// Internet Explorer HTML Access class written by ElmüSoft for Code Project
//                          www.elmue.de.vu
//                          kickme.to/elmue
// ************************************************************************

#if !defined(HTML_EDITOR_H__AF3E29B6_2B28_46D0_9D37_74D6C9E41B4A__INCLUDED_)
#define HTML_EDITOR_H__AF3E29B6_2B28_46D0_9D37_74D6C9E41B4A__INCLUDED_

#pragma once

#include <atlbase.h>          // CComPtr
#include <afxhtml.h>          // CHtmlView

#include "VS7/mshtml_VS7.h"   // IHTMLDomNode etc..
#include "VS7/MsHtmcid_VS7.h" // IDM_JUSTIFYLEFT etc..

#define WM_IDLEUPDATECMDUI  0x0363

#define _HKLM  HKEY_LOCAL_MACHINE
#define _HKCU  HKEY_CURRENT_USER
#define _HKCR  HKEY_CLASSES_ROOT

#if _MSC_VER > 1200 // > Visual Studio 6.0
#error "This code is written for Visual Studio 6. Download the version for Visual Studio 7 instead from CodeProject.com!"
#endif

#define HTMLEDIT_INIT_DONE   5000
#define HTMLEDIT_UPDATE_UI   5001
#define HTMLEDIT_KILLFOCUS   5002
#define HTMLEDIT_SETDEFAULT  5003
#define HTMLEDIT_NAVIGATED   5004
#define IDM_FONTSIZE_STYLE   5005
#define ID_TIMER_WAIT_BUSY   5006

class AFX_EXT_CLASS CHtmlEditor : public CHtmlView
{
public:

	// Forward declarations of embedded classes
	class cHtmlStyle;
	class cHtmlStyleSheet;
	class cHtmlDomNode;
	class cHtmlElement;
	class cHtmlTableCell;
	class cHtmlTableRow;
	class cHtmlTable;
	class cHtmlHR;
	class cHtmlImg;
	class cHtmlDocument;

	class CUniRichEdit;
	class cMisc;
	class CMsieWnd;
	class cStreamReader;

	// ####################################################

	class cMisc
	{
	public:
		static CString DecodeMime(CString s_Text);
		static CString EncodeHtml(BSTR bs_Html);
		static void    EncodeHtml(const WCHAR *u16_In, UINT *pu32_WcharToCopy, char *s8_Out, UINT *pu32_OutSize);
		static CString VarToStr(CComVariant &v_Variant);
		static CString RemoveTag(CString s_Html, CString s_Tag);
		static CString CutString(CString s_In, CString s_Cut, BOOL b_End);
		static void    RegWriteString(HKEY h_Class, CString s_Path, CString s_Key, CString s_Value);
		static void    RegWriteDword (HKEY h_Class, CString s_Path, CString s_Key, DWORD u32_Value);
	};
	// ####################################################

	// These definitions must have the same order as enum eProp !
	// C2059: syntax error : 'string' is caused by a
	// Compiler bug: Don't put a space behind "\" here !!!!!!!!!!
	#define __StyleNames { _T("background-color:"), \
	                       _T("color:"),            \
	                       _T("border:"),           \
	                       _T("border-width:"),     \
	                       _T("border-style:"),     \
	                       _T("font-size:"),        \
	                       _T("font-family:"),      \
	                       _T("width:"),            \
	                       _T("height:"),           \
	                       _T("text-decoration:") }

	class cHtmlStyle : public cMisc
	{
	public:
		enum eProp
		{
			E_BackgColor = 0,
			E_ForeColor,   // text color
			E_Border,
			E_BorderWidth,
			E_BorderStyle,
			E_FontSize,
			E_FontFamily,
			E_Width,
			E_Height,
			E_Decoration,
			// to be expanded here.. (update also __StyleNames !!)
		};

		cHtmlStyle(CComPtr<IHTMLStyle>     i_Style);
		cHtmlStyle(CComPtr<IHTMLRuleStyle> i_RuleStyle);

		virtual BOOL Valid();
		CString GetProperty(eProp e_Prop);
		BOOL SetProperty(eProp e_Prop, CString s_Value);

	protected:
		CComPtr<IHTMLStyle>     mi_Style;
		CComPtr<IHTMLRuleStyle> mi_RuleStyle;
	};


	// ####################################################

	class cHtmlStyleSheet : public cMisc
	{
	public:
		cHtmlStyleSheet(CComPtr<IHTMLStyleSheet> i_Sheet);

		virtual BOOL Valid();
		cHtmlStyle GetRule(CString s_Selector);
		BOOL SetProperty(CString s_Selector, cHtmlStyle::eProp e_Prop, CString s_Value);

	protected:
		BOOL AddRule(CString s_Selector, cHtmlStyle::eProp e_Prop, CString s_Value);

		CComPtr<IHTMLStyleSheet>                mi_Sheet;
		CComPtr<IHTMLStyleSheetRulesCollection> mi_Collect;
	};


	// ####################################################

	class cHtmlDomNode : public cMisc
	{
	public:
		cHtmlDomNode(CComPtr<IHTMLDOMNode> i_Dom);

		virtual BOOL Valid();
		cHtmlElement NextSibling();
		cHtmlElement PreviousSibling();
		BOOL Remove();
		BOOL Strip();
		cHtmlElement AppendChild(cHtmlElement i_NewChild);

	protected:
		CComQIPtr<IHTMLDOMNode, &IID_IHTMLDOMNode> mi_Dom;
	};


	// ####################################################

	class cHtmlElement : public cHtmlDomNode
	{
	public:
		cHtmlElement(CComPtr<IHTMLElement> i_Elem);
		const cHtmlElement& operator=(const cHtmlElement& El);
		operator CComPtr<IHTMLElement>();

		virtual BOOL Valid();
		CString GetTagName();
		CString GetClassName();
		cHtmlElement GetParent();
		UINT GetChildCollection(CComQIPtr<IHTMLElementCollection> &i_Collect);
		cHtmlElement FindParent(CString s_Tag);
		cHtmlElement SkipParents(CString s_Tags);
		CString GetAttribute(CString s_AttrName);
		BOOL SetAttribute(CString s_AttrName, CString s_Value);
		BOOL RemoveAttribute(CString s_AttrName);
		CString GetInnerText();
		BOOL SetInnerHtml(CString s_Html);
		BOOL IsEmpty();
		CString GetInnerHtml();
		CString GetOuterHtml();
		BOOL InsertHtml(CString s_Html, BOOL b_AtBegin, BOOL b_Inside);
		cHtmlStyle GetStyle();
		cHtmlElement AppendNewChild(CString s_Tag);

		static cHtmlElement GetElementFromCollection(UINT u32_Index, CComQIPtr<IHTMLElementCollection> &i_Collect);

	protected:
		CComQIPtr<IHTMLElement, &IID_IHTMLElement> mi_Elem;
	};

	// ####################################################

	class cHtmlTableCell : public cHtmlElement
	{
	public:
		cHtmlTableCell(CComPtr<IHTMLElement> i_Elem);

		virtual BOOL Valid();
		cHtmlTableRow GetParentRow();
		cHtmlTable    GetParentTable();
		BOOL SetColSpan(UINT Span);
		UINT GetCellIndex();
		UINT GetColIndex();
		UINT GetRowIndex();
		UINT GetColSpan();
		UINT GetRowSpan();
		BOOL Combine();
		void Split();
		BOOL SetInnerHtml(CString s_Html);
		void    SetBgColor(CString s_Color);
		CString GetBgColor();

	protected:
		CComQIPtr<IHTMLTableCell, &IID_IHTMLTableCell> mi_Cell;
	};

	// ####################################################

	class cHtmlTableRow : public cHtmlElement
	{
	public:
		cHtmlTableRow(CComPtr<IHTMLElement> i_Elem);

		virtual BOOL Valid();
		UINT GetCellCount();
		UINT GetRowIndex();
		BOOL DeleteCell(UINT Index);
		BOOL DeleteColumn(UINT Index);
		cHtmlTableCell InsertColumn(UINT Index);
		cHtmlTableCell GetCell     (UINT Index);
		cHtmlTableCell GetColumn   (UINT Index, BOOL b_ReturnPrevious =FALSE);
		cHtmlTableCell InsertCell  (UINT Index);
		cHtmlTable GetParentTable();

	protected:
		CComQIPtr<IHTMLTableRow, &IID_IHTMLTableRow> mi_Row;
	};

	// ####################################################

	class cHtmlTable : public cHtmlElement
	{
	public:
		enum eRules // Table border
		{
			E_RulesAll  = 0,  // Horizontal lines, vertical lines and box
			E_RulesHor  = 1,  // Horizontal lines and box
			E_RulesVert = 2,  // Vertikal   lines and box
			E_RulesBox  = 3   // Only Box (border around)
		};
		cHtmlTable(CComPtr<IHTMLElement> i_Elem);

		virtual BOOL Valid();
		CString GetBgColor();
		void SetBgColor(CString s_Color);
		BOOL DeleteRow(UINT Index);
		BOOL DeleteColumn(UINT Index);
		cHtmlTableRow GetRow   (UINT Index);
		cHtmlTableRow InsertRow(UINT Index, int CellCount);
		BOOL InsertColumn(UINT Index);
		BOOL GetSpanMap(UINT *pu32_Rows, UINT *pu32_Cols, UINT **ppu32_Map);
		void CleanUp();
		UINT GetColumnCount();
		UINT GetRowCount();
		cHtmlTableCell GetCell(UINT u32_Row, UINT u32_Column, BOOL b_ReturnPrevious=FALSE);
		CString GetCellPadding();
		BOOL SetCellPadding(CString s_Padding);
		CString GetCellSpacing();
		BOOL SetCellSpacing(CString s_Spacing);
		CString GetBorderWidth();
		BOOL SetBorderWidth(CString s_Width);
		CString GetBorderColor();
		BOOL SetBorderColor(CString s_Color);
		eRules GetBorderRules();
		BOOL SetBorderRules(eRules e_Rules);

	protected:
		CComQIPtr<IHTMLTable, &IID_IHTMLTable> mi_Table;
	};

	// ####################################################

	class cHtmlImg : public cHtmlElement
	{
	public:
		cHtmlImg(CComPtr<IHTMLElement> i_Elem);

		virtual BOOL Valid();
		CString GetUrl();
		BOOL    SetSrc(CString s_Src);

	protected:
		CComQIPtr<IHTMLImgElement, &IID_IHTMLImgElement> mi_Img;
	};

	// ####################################################

	class cHtmlHR : public cHtmlElement
	{
	public:
		cHtmlHR(CComPtr<IHTMLElement> i_Elem);

		enum eAction
		{
			E_Color,
			E_Size,   // the height of the line in pixel
			E_Width,  // the length of the line in pixel or percent
			E_Align
		};
		virtual BOOL Valid();
		void SetProperty(eAction e_Action, CString s_Value);
		CString GetProperty(eAction e_Action);
		BOOL GetShade();
		void SetShade(BOOL b_Shade);

	protected:
		CComQIPtr<IHTMLHRElement, &IID_IHTMLHRElement> mi_HR;
	};

	// ####################################################

	class cHtmlDocument : public cHtmlDomNode
	{
	public:		
		BOOL InsertTable(UINT u32_Rows, UINT u32_Cols, UINT uborder = 1, CString strBorderColor=_T("silver"), UINT uCellPadding = 1, UINT uCellSpacing = 1,  CString strWidth = 50, CString strHeight = 50, CString strBGColor = _T("white"));
		cHtmlDocument();
		void Assign(CComPtr<IDispatch> D_Doc, CHtmlEditor *pi_Editor);

		virtual BOOL Valid();
		cHtmlStyleSheet GetStyleSheet();
		BOOL SetDocumentDefault(CString s_Selector, cHtmlStyle::eProp e_Prop, CString s_Value);
		BOOL IsModified();
		cHtmlElement GetElementByID(CString s_ID);
		UINT QueryStatus(UINT u32_Command);
		CString GetTitle();
		CString GetUrl();
		BOOL ExecSetCommand(UINT u32_Command, CComVariant v_In=0, BOOL b_PromtUser=TRUE);
		BOOL ExecGetCommand(UINT u32_Command, CComVariant *pv_Out);
		CString GetHtml();
		cHtmlElement GetHtmlTag();
		cHtmlElement GetHead();
		cHtmlElement GetBody(BOOL b_Create);
		void CleanUpTags();
		cHtmlElement GetSelection(BOOL b_AllowEmptySel=TRUE);
		UINT GetElementCollection(CString s_TagName, CComQIPtr<IHTMLElementCollection> &i_Collect);
		BOOL PasteIntoSelection(CString s_Html);
		BOOL AddToSelection(CString s_BeginHtml, CString s_EndHtml);
		BOOL SetHtml(CString s_HTML);
		BOOL SetDesignMode(BOOL b_Design);
		BOOL GetDesignMode();
		BOOL FocusWindow();
		cHtmlTableCell GetSelectedCell();
		void InsertNewTableColumn(BOOL b_Right);
		void InsertNewTableRow(BOOL b_Below);
		BOOL InsertNewImage(CString s_Path);
		BOOL SetSelectionFontSize(UINT u32_Size);
		UINT GetSelectionFontSize();
		UINT GetDefaultFontSize();
		UINT ConvertFontSize(CString s_Size);
		void MakeImagesAbsolute();

	protected:
		void RecursiveSetFontSize(cHtmlElement &i_Parent, CString *ps_Size);
		void RecursiveCleanUpChilds(cHtmlElement &i_Elem, CString *ps_Removed);
		BOOL ReplaceHeading(CString s_Tag, cHtmlElement &i_Elem);
		BOOL ReplaceParagraph(cHtmlElement &i_Elem);

		CHtmlEditor                  *mp_Editor;
		CComQIPtr<IHTMLDocument2>     mi_Doc2;
		CComQIPtr<IHTMLDocument3>     mi_Doc3;
		CComQIPtr<IHTMLDocument4>     mi_Doc4;
		CComQIPtr<IPersistStreamInit> mi_PStream;
		CComQIPtr<IOleCommandTarget>  mi_CmdTarg;

		int                         ms32_DefaultFontSize;
	};

	// #####################################################

	class CMsieWnd : public CWnd
	{
	public:
		void SetEditor(CHtmlEditor *p_Editor);

	protected:
		virtual LRESULT WindowProc(UINT message, WPARAM wParam, LPARAM lParam);
		virtual BOOL PreTranslateMessage(MSG* pMsg);

	private:
		CHtmlEditor *mp_Editor;
	};
		
	// #####################################################

	class CUniRichEdit : public CWnd, public cMisc
	{
	public:
		CUniRichEdit();
		virtual ~CUniRichEdit();

		void SetEditor(CHtmlEditor *p_Editor);
		BOOL CreateEx(DWORD u32_ExStyle, DWORD u32_Style, const RECT& k_Rect, CWnd* p_Parent, UINT u32_ID);
		void SetWindowText(CString s_Text);

	private:
		virtual BOOL PreTranslateMessage(MSG* pMsg);

		HINSTANCE mh_Dll32;
		HINSTANCE mh_Dll20;
		CHtmlEditor *mp_Editor;
	};
		
	// #####################################################

	class cStreamReader : public IStream, public cMisc
	{
	public:
		cStreamReader();
		virtual ~cStreamReader();
		void SetData(LPCTSTR szData);
		ULONG STDMETHODCALLTYPE AddRef();
		ULONG STDMETHODCALLTYPE Release(); 
		STDMETHOD(QueryInterface)(REFIID iid, void **ppUnk);
		STDMETHOD(Read)(void *pv_Buffer, ULONG u32_BufSize, ULONG *pu32_ReadBytes);
		STDMETHOD(Write)(const void *pv_Buffer, ULONG u32_BufSize, ULONG *pcbWritten);
		STDMETHOD(Seek)(LARGE_INTEGER, DWORD, ULARGE_INTEGER*);
		STDMETHOD(SetSize)(ULARGE_INTEGER);
		STDMETHOD(CopyTo)(IStream *, ULARGE_INTEGER, ULARGE_INTEGER*, ULARGE_INTEGER*);
		STDMETHOD(Commit)(DWORD);
		STDMETHOD(Revert)();
		STDMETHOD(LockRegion)(ULARGE_INTEGER, ULARGE_INTEGER, DWORD);
		STDMETHOD(UnlockRegion)(ULARGE_INTEGER, ULARGE_INTEGER, DWORD);
		STDMETHOD(Stat)(STATSTG*, DWORD);
		STDMETHOD(Clone)(IStream**);

	protected:
		char *mps8_Data;
		UINT  mu32_DataLen;
		UINT  mu32_Index;
	};

// END embedded classes

// ####################################################

// class CHtmlEditor :

	DECLARE_DYNCREATE(CHtmlEditor)
public:
	CHtmlEditor();
	virtual ~CHtmlEditor();

	virtual BOOL Valid();
	void Clear();
	void Save();
	BOOL ExecSetCommand(UINT u32_Command, CComVariant v_In=0, BOOL b_PromtUser=TRUE);
	BOOL ExecGetCommand(UINT u32_Command, CComVariant *pv_Out);
	BOOL ExecGetCommandStr(UINT u32_Command, CString *ps_Out);
	UINT QueryStatus(UINT u32_Command);
	BOOL CreateEditor(CWnd *p_Static, CWnd *p_NotificationWnd, BOOL b_EditOnlyBody, BOOL b_EnableThemes);
	void ResetMsieSettings();
	void SetDisplayMode(BOOL b_SourceMode, BOOL b_DesignMode);
	void EnableEditor(BOOL b_Enable);
	void MoveWindow(int Left, int Top, int Width, int Height, UINT u32_Flags=0);
	void MoveWindow(CRect k_Rect, UINT u32_Flags=0);
	void ReplaceParagraphs(UINT u32_VirtKeyCode);
	cHtmlDocument* GetDocument();
	BOOL NavigateToEmbeddedResource(CString s_RsrcName);
	BOOL Navigate(LPCTSTR t_URL, DWORD dwFlags=0, LPCTSTR lpszTargetFrameName=0, LPCTSTR lpszHeaders=0, LPVOID lpvPostData=0, DWORD dwPostDataLen=0);
	UINT GetDisplayMode();
	void NotifyParent(UINT u32_CommandID, BOOL b_Post);
	UINT GetMsieVersion();
	BOOL IsPlatformNT();
	void DelayCeanUp();

protected:
	virtual void OnBeforeNavigate2(LPCTSTR t_URL, DWORD u32_Flags, LPCTSTR t_TargetFrame, CByteArray& i_PostedData, LPCTSTR t_Headers, BOOL *pb_Cancel);
	virtual void OnNavigateComplete2(LPCTSTR t_URL);
	virtual LRESULT WindowProc(UINT message, WPARAM wParam, LPARAM lParam);
public:
	CUniRichEdit   mi_RichEdit;
private:
	BOOL           mb_SourceMode;
	BOOL           mb_Enabled;
	cHtmlDocument  mi_HtmDoc;
	CMsieWnd       mi_MSIE;

	CWnd          *mp_NotificationWnd;
	CWnd          *mp_Static;
	BOOL           mb_EditOnlyBody;
	BOOL           mb_InitDone;
	BOOL           mb_CleanUp;
	BOOL           mb_SubClassed;
	BOOL           mb_EnableThemes;
	BOOL           mb_PlatformNT;
	BOOL           mb_ParaReplaced;
};


// these typedefs avoid that you have to tpye "CHtmlEditor::cHtmlTable" each time 
// instead of simply typing "cHtmlTable"

typedef CHtmlEditor::cMisc            cMisc;
typedef CHtmlEditor::cHtmlStyle       cHtmlStyle;
typedef CHtmlEditor::cHtmlStyleSheet  cHtmlStyleSheet;
typedef CHtmlEditor::cHtmlDomNode     cHtmlDomNode;
typedef CHtmlEditor::cHtmlElement     cHtmlElement;
typedef CHtmlEditor::cHtmlTableCell   cHtmlTableCell;
typedef CHtmlEditor::cHtmlTableRow    cHtmlTableRow;
typedef CHtmlEditor::cHtmlTable       cHtmlTable;
typedef CHtmlEditor::cHtmlHR          cHtmlHR;
typedef CHtmlEditor::cHtmlImg         cHtmlImg;
typedef CHtmlEditor::cHtmlDocument    cHtmlDocument;
typedef CHtmlEditor::CUniRichEdit     CUniRichEdit;
typedef CHtmlEditor::CMsieWnd         CMsieWnd;
typedef CHtmlEditor::cStreamReader    cStreamReader;


#endif // !defined(HTML_EDITOR_H__AF3E29B6_2B28_46D0_9D37_74D6C9E41B4A__INCLUDED_)

